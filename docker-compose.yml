# ============================================================
# Hytale Dedicated Server - Docker Compose
# ============================================================
#
# HOST PFADE: /opt/hytale/
# CONTAINER PFADE: /opt/hytale/
#
# PORTAINER SETUP:
# 1. Repository URL eingeben
# 2. Environment Variables in Portainer setzen (NICHT als .env Datei!)
# 3. Deploy
# 4. Nach Start: /auth login device
#
# LOKAL:
# 1. cp .env.example .env
# 2. .env anpassen
# 3. docker-compose up -d
#
# WEB MANAGER:
# Nach dem Start erreichbar unter http://localhost:18080
# Login mit MANAGER_USERNAME/MANAGER_PASSWORD
#
# ============================================================

services:
  hytale:
    build: .
    container_name: hytale
    hostname: hytale
    restart: on-failure:3
    
    environment:
      # Java / RAM
      - JAVA_MIN_RAM=${JAVA_MIN_RAM:-3G}
      - JAVA_MAX_RAM=${JAVA_MAX_RAM:-4G}
      
      # Server
      - SERVER_PORT=${SERVER_PORT:-5520}
      - SERVER_BIND=${SERVER_BIND:-0.0.0.0}
      - TZ=${TZ:-Europe/Berlin}
      
      # Backups
      - ENABLE_BACKUP=${ENABLE_BACKUP:-true}
      - BACKUP_FREQUENCY=${BACKUP_FREQUENCY:-30}
      
      # Auth
      - AUTH_MODE=${AUTH_MODE:-}
      
      # Download URLs (Option 1)
      - SERVER_JAR_URL=${SERVER_JAR_URL:-}
      - ASSETS_URL=${ASSETS_URL:-}
      
      # Hytale Downloader (Option 2)
      - USE_HYTALE_DOWNLOADER=${USE_HYTALE_DOWNLOADER:-false}
      - HYTALE_PATCHLINE=${HYTALE_PATCHLINE:-release}
      
      # Auto-update on restart
      - AUTO_UPDATE=${AUTO_UPDATE:-false}

      # EasyWebMap (optional)
      - WEBMAP_PORT=${WEBMAP_PORT:-18081}
      - WEBMAP_WS_PORT=${WEBMAP_WS_PORT:-18082}

    # Ports - UDP for game, TCP for webmap
    ports:
      - "${SERVER_PORT:-5520}:${SERVER_PORT:-5520}/udp"
      - "${WEBMAP_PORT:-18081}:${WEBMAP_PORT:-18081}/tcp"
      - "${WEBMAP_WS_PORT:-18082}:${WEBMAP_WS_PORT:-18082}/tcp"
    
    # Volumes - Bind Mounts zu /opt/hytale/
    volumes:
      - /opt/hytale/server:/opt/hytale/server
      - /opt/hytale/data:/opt/hytale/data
      - /opt/hytale/backups:/opt/hytale/backups
      - /opt/hytale/plugins:/opt/hytale/plugins
      - /opt/hytale/mods:/opt/hytale/mods
      - /opt/hytale/downloader:/opt/hytale/downloader
      - /opt/hytale/auth:/opt/hytale/auth

    # Console
    stdin_open: true
    tty: true
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Network for manager communication
    networks:
      - hytale-net

    # SECURITY: Resource limits to prevent resource exhaustion
    # Note: DOCKER_MEMORY_LIMIT should be >= JAVA_MAX_RAM + 1G for overhead
    deploy:
      resources:
        limits:
          cpus: '${DOCKER_CPU_LIMIT:-4}'
          memory: ${DOCKER_MEMORY_LIMIT:-8G}
        reservations:
          cpus: '1'
          memory: ${JAVA_MAX_RAM:-4G}

  # ============================================================
  # Hytale Server Manager - Web UI
  # ============================================================
  hytale-manager:
    build: ./manager
    container_name: hytale-manager
    hostname: hytale-manager
    restart: unless-stopped

    environment:
      # Authentication
      - MANAGER_USERNAME=${MANAGER_USERNAME:-admin}
      - MANAGER_PASSWORD=${MANAGER_PASSWORD:-changeme}
      - JWT_SECRET=${JWT_SECRET:-please-change-this-secret-key}

      # Target container
      - GAME_CONTAINER_NAME=hytale

      # Paths (inside container)
      - SERVER_PATH=/opt/hytale/server
      - BACKUPS_PATH=/opt/hytale/backups
      - DATA_PATH=/opt/hytale/data

      # Settings
      - TZ=${TZ:-Europe/Berlin}

    ports:
      - "${MANAGER_PORT:-18080}:18080"

    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Shared volumes with game server (host: /opt/hytale/, container: /opt/hytale/)
      # Server configs need write access for the config editor
      - /opt/hytale/server:/opt/hytale/server
      - /opt/hytale/backups:/opt/hytale/backups
      - /opt/hytale/data:/opt/hytale/data
      - /opt/hytale/mods:/opt/hytale/mods
      - /opt/hytale/plugins:/opt/hytale/plugins

      # Manager persistent data
      - manager-data:/app/data

    networks:
      - hytale-net

    depends_on:
      - hytale

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # SECURITY: Resource limits for manager
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

# ============================================================
# Networks
# ============================================================
networks:
  hytale-net:
    driver: bridge

# ============================================================
# Volumes
# ============================================================
volumes:
  manager-data:
